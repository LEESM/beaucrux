{% extends "base.html" %}
{% load humanize %}

{% block content %}
<script type="text/javascript" src="https://service.iamport.kr/js/iamport.payment-1.1.1.js"></script>
<script>
	$(function() {

	});
</script>
<div class="container">
	<h2>상품정보</h2>
	<div class="table-responsive">
		<table class="table">
			<thead id="cart_thead">
				<tr>
					<th>사진</th>
					<th>아이템-옵션</th>
					<th>가격</th>
					<th>개수</th>
					<th>합계</th>
				</tr>
			</thead>
			<tbody id="cart_tbody">
				{% for cart_item in cart_items %}
				<tr>
					<td><img style="max-width:80px;" src="{{cart_item.item.image0.url}}"/></td>
					<td>{{ cart_item.item }} : {{ cart_item.item_option }}( +{{cart_item.item_option.option_price|intcomma}}원 ) </td>
					<td>{{cart_item.item_plus_option_price|intcomma}}원</td>
					<td>{{cart_item.quantity}}</td>
					<td>{{cart_item.sub_total_price|intcomma}}원</td>
				</tr>
				{% endfor %}
				<tr>
					<td colspan="4">주문금액 </td>
					<td>{{ item_price|intcomma }}원</td>
				</tr>
				<tr>
					<td colspan="4">배송비</td>
					<td>{{ delivery_price|intcomma }}원</td>
				</tr>
				<tr>
					<td colspan="4">총계</td>
					<td>{{ total_price|intcomma }}원</td>
				</tr>
				<tr>
					<td colspan="4">구매로 받는 포인트</td>
					<td>{{ point_made|intcomma }}</td>
				</tr>
			</tbody>
		</table>
	</div>

	<h2>배송정보</h2>
	<div class="table-responsive">
		<form id="aksgdltktpdy" method="post" action="{% url 'order_update' %}">
		{% csrf_token %}
			<table class="table">
				<tr class="hidden">
					<th><label for="id_order_id">Order id:</label></th>
					<td><input id="id_order_id" name="order_id" type="text" /></td>
				</tr>
				<tr class="hidden">
					<th><label for="id_cart_id">Cart id:</label></th>
					<td><input value = "{{cart_id}}" id="id_cart_id" name="cart_id" type="text" /></td>
				</tr>
				<tr class="hidden">
					<th><label for="id_item_price">Item price:</label></th>
					<td><input value = "{{item_price}}" id="id_item_price" name="item_price" type="number" /></td>
				</tr>
				<tr class="hidden">
					<th><label for="id_delivery_price">Delivery price:</label></th>
					<td><input value = "{{delivery_price}}" id="id_delivery_price" name="delivery_price" type="number" /></td>
				</tr>
				<tr class="hidden">
					<th><label for="id_total_price">Total price:</label></th>
					<td><input value = "{{total_price}}" id="id_total_price" name="total_price" type="number" /></td>
				</tr>
				<tr class="hidden">
					<th><label for="id_pay_price">Pay price:</label></th>
					<td><input id="id_pay_price" name="pay_price" type="number" /></td>
				</tr>
				<tr class="hidden">
					<th><label for="id_point_made">Point made:</label></th>
					<td><input value="{{point_made}}" id="id_point_made" name="point_made" type="number" /></td>
				</tr>
				<tr>
					<th><label for="id_name">성함</label></th>
					<td><input value = "{{ request.user.first_name }}" class="form-control" id="id_name" name="name" type="text" /></td>
				</tr>
				<tr>
					<th><label for="id_email">Email</label></th>
					<td><input value = "{{ request.user.email }}" class="form-control" id="id_email" name="email" type="text" /></td>
				</tr>
				<tr>
					<th><label for="id_postcode">우편번호</label></th>
					<td style="text-align:left;">
						<div class="form-inline">
							<input type="text" id="postcode" name="postcode" class="form-control" style="max-width:100px; display:inline; vertical-align: top;" placeholder="우편번호" value="{{ user.profile.postcode }}">
							<input type="button" class="btn btn-default"onclick="sample3_execDaumPostcode()" value="우편번호 찾기"><br>
						</div>
					</td>
				</tr>
				<tr>
					<th><label for="id_address">주소</label></th>
					<td>
						<div id="wrap" style="display:none;border:1px solid;min-width:100%;height:400px;margin:5px 0;position:relative">
						<img src="//i1.daumcdn.net/localimg/localimages/07/postcode/320/close.png" id="btnFoldWrap" style="cursor:pointer;position:absolute;right:0px;top:-1px;z-index:1" onclick="foldDaumPostcode()" alt="접기 버튼">
						</div>
						<input type="text" id="address" name="address" class="d_form large form-control" placeholder="주소" value="{{ user.profile.address }}">						
					</td>
				</tr>
				<tr>
					<th><label for="id_address_detail">상세주소</label></th>
					<td>
						<input type="text" id="address_detail" name="address_detail" class="d_form large form-control" placeholder="상세주소" value="{{ user.profile.address_detail }}">
					</td>
				</tr>
				<tr>
					<th><label for="id_phone">폰번호</label></th>
					<td><input value = "{{request.user.profile.phone}}" class="form-control" id="id_phone" name="phone" type="text" /></td>
				</tr>
				<tr>
					<th><label for="id_postscript">남기는 말</label></th>
					<td><input class="form-control" id="id_postscript" name="postscript" type="text" /></td>
				</tr>
				<tr {% if anonymous %} class="hidden" {% endif %} >
					<th><label for="id_point_price">포인트 사용 (사용가능 : {{request.user.profile.point|intcomma}})</label></th>
					<td><input id="id_point_price" class="form-control" name="point_price" type="number" value=0 /></td>
				</tr>
				<tr>
					<th>결제방법선택</th>
					<td>
						<label class="radio-inline">
						  <input type="radio" name="pay_method" id="pay_method" value="card"checked="checked"> 신용카드
						</label>
						<label class="radio-inline">
						  <input type="radio" name="pay_method" id="pay_method" value="trans"> 계좌이체
						</label>
						<label class="radio-inline">
						  <input type="radio" name="pay_method" id="pay_method" value="vbank"> 무통장입금
						</label>
					</td>
				</tr>
			</table>
			<div class="checkbox {% if anonymous %} hidden {% endif %}"  >
				<label>
					<input name="mypage_check" id="mypage_check" type="checkbox" checked="checked">마이페이지에 정보를 반영합니다.
				</label>
			</div>
		</form>
		<div>
			<button id="buy_btn" href="{% url 'order_info' %}" class="btn btn-lg btn-primary">구매하기</button>
		</div>
		<script>
		$(function() {
			var raw  = new Date();
			var cart_id = $('#id_cart_id').val();
			var order_id = raw.getFullYear().toString() + ("0"+(raw.getMonth()+1)).slice(-2).toString() + ("0"+raw.getDate()).slice(-2).toString()+("0"+raw.getHours()).slice(-2).toString() + ("0"+raw.getMinutes()).slice(-2).toString() + ("0"+raw.getSeconds()).slice(-2).toString() + "_" + cart_id;
			var test = raw.getMinutes();
			$("#id_order_id").val(order_id);
			var tot = $('#id_total_price').val();
			$("#id_pay_price").val(tot);
			$( "#id_point_price" ).change(function() {
				var point = $('#id_point_price').val();
				if(point<0){
					point=0;
				}else if(point>{% if anonymous %}0{% else %}{{ request.user.profile.point }}{%endif %}){
					point= {% if anonymous %}0{% else %}{{ request.user.profile.point }}{%endif %} ;
				}
				$("#id_point_price").val(point);
				var pay = tot-point;
				$('#id_pay_price').val(pay);
			});
			$('#buy_btn').click(function(e){
				//var mypage_check = $('input:checkbox[id="mypage_check"]').is(":checked");
				var IMP = window.IMP;
				IMP.init('imp89113577');
				IMP.request_pay({
				    pg : 'inicis', // version 1.1.0부터 지원.
				    pay_method : $('#pay_method:checked').val(), // 'card' : 신용카드 | 'trans' : 실시간계좌이체 | 'vbank' : 가상계좌 | 'phone' : 휴대폰소액결제
				    merchant_uid : 'merchant_' + new Date().getTime(),
				    name : '{{ pg_product_name }} 외',
				    amount : $('#id_pay_price').val(),
				    buyer_email : $('#id_email').val(),
				    buyer_name : $('#id_name').val(),
				    buyer_tel : $('#id_phone').val(),
				    buyer_addr : $('#id_address').val(),
					m_redirect_url : 'http://127.0.0.1:8000/order/mobile_redirect/',
				}, function(rsp) {
					  if ( rsp.success === true ) {//성공이면 true, 실패면 false
					    if ( rsp.success ) {
					        //[1] 서버단에서 결제정보 조회를 위해 jQuery ajax로 imp_uid 전달하기
					        jQuery.ajax({
					            url: "/order/complete", //cross-domain error가 발생하지 않도록 동일한 도메인으로 전송
					            type: 'POST',
					            dataType: 'json',
					            data: {
					                imp_uid : rsp.imp_uid,
					                paid_amount : rsp.paid_amount,
					                //기타 필요한 데이터가 있으면 추가 전달
					            }
					        }).done(function(data) {
					        		alert(data);
					            //[2] 서버에서 REST API로 결제정보확인 및 서비스루틴이 정상적인 경우
					            if ( data == 'result1' ) {
					                var msg = '결제가 완료되었습니다.';
					                msg += '\n고유ID : ' + rsp.imp_uid;
					                msg += '\n상점 거래ID : ' + rsp.merchant_uid;
					                msg += '\결제 금액 : ' + rsp.paid_amount;
					                msg += '카드 승인번호 : ' + rsp.apply_num;

					                alert(msg);
										$("#aksgdltktpdy").submit();

					            } else {
					            		alert('제대로 결제가 되지 않았습니다. 관리자에게 문의해주세요.');
					                //[3] 아직 제대로 결제가 되지 않았습니다.
					                //[4] 결제된 금액이 요청한 금액과 달라 결제를 자동취소처리하였습니다.
					            }
					        });
					    } else {
					        var msg = '결제에 실패하였습니다.';
					        msg += '에러내용 : ' + rsp.error_msg;

					        alert(msg);
					    }
						//$("#aksgdltktpdy").submit();
					  }
					});
						//$("#aksgdltktpdy").submit();
			});
		});
		</script>
		<script src="http://dmaps.daum.net/map_js_init/postcode.v2.js"></script>
		<script>
		    // 우편번호 찾기 찾기 화면을 넣을 element
		    var element_wrap = document.getElementById('wrap');

		    function foldDaumPostcode() {
		        // iframe을 넣은 element를 안보이게 한다.
		        element_wrap.style.display = 'none';
		    }

		    function sample3_execDaumPostcode() {
		        // 현재 scroll 위치를 저장해놓는다.
		        var currentScroll = Math.max(document.body.scrollTop, document.documentElement.scrollTop);
		        new daum.Postcode({
		            oncomplete: function(data) {
		                // 검색결과 항목을 클릭했을때 실행할 코드를 작성하는 부분.

		                // 각 주소의 노출 규칙에 따라 주소를 조합한다.
		                // 내려오는 변수가 값이 없는 경우엔 공백('')값을 가지므로, 이를 참고하여 분기 한다.
		                var fullAddr = data.address; // 최종 주소 변수
		                var extraAddr = ''; // 조합형 주소 변수

		                // 기본 주소가 도로명 타입일때 조합한다.
		                if(data.addressType === 'R'){
		                    //법정동명이 있을 경우 추가한다.
		                    //if(data.bname !== ''){
		                    //    extraAddr += data.bname;
		                    //}
		                    // 건물명이 있을 경우 추가한다.
		                    if(data.buildingName !== ''){
		                        extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
		                    }
		                    // 조합형주소의 유무에 따라 양쪽에 괄호를 추가하여 최종 주소를 만든다.
		                    fullAddr += (extraAddr !== '' ? ' '+ extraAddr +' ' : '');
		                }

		                // 우편번호와 주소 정보를 해당 필드에 넣는다.
		                document.getElementById('postcode').value = data.zonecode; //5자리 새우편번호 사용
		                document.getElementById('address').value = fullAddr;

		                // iframe을 넣은 element를 안보이게 한다.
		                // (autoClose:false 기능을 이용한다면, 아래 코드를 제거해야 화면에서 사라지지 않는다.)
		                element_wrap.style.display = 'none';

		                // 우편번호 찾기 화면이 보이기 이전으로 scroll 위치를 되돌린다.
		                document.body.scrollTop = currentScroll;
		            },
		            // 우편번호 찾기 화면 크기가 조정되었을때 실행할 코드를 작성하는 부분. iframe을 넣은 element의 높이값을 조정한다.
		            onresize : function(size) {
		                element_wrap.style.height = size.height+'px';
		            },
		            width : '100%',
		            height : '100%'
		        }).embed(element_wrap);

		        // iframe을 넣은 element를 보이게 한다.
		        element_wrap.style.display = 'block';
		    }
		</script>
	</div>
</div>
{% endblock %}